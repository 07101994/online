#
# spec file for package loolwsd
#
# Copyright (c) 2015 Collabora
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.


# See also http://en.opensuse.org/openSUSE:Specfile_guidelines

Name:           loolwsd
Version:        @PACKAGE_VERSION@
Release:        0
Vendor:         Collabora
Summary:        LibreOffice On-Line WebSocket Daemon
License:        MPL
Source0:        loolwsd-@PACKAGE_VERSION@.tar.gz
BuildRequires:  libcap-progs libcap-devel libpng-devel poco-devel >= 1.6.0
# This works for now only with the TDF nightly builds of 5.0 or 5.1, I
# think. But the TDF packages include the version number in their
# names. How clever is that? So we need to specify one.
Requires:       libcap libcap-progs libpng libPocoFoundation30 >= 1.6.0 libPocoNet30 >= 1.6.0 libreofficedev5.1 libreofficedev5.1-en-US libreofficedev5.1-ure lodevbasis5.1-core lodevbasis5.1-writer lodevbasis5.1-impress lodevbasis5.1-graphicfilter lodevbasis5.1-en-US lodevbasis5.1-calc lodevbasis5.1-en-US-res lodevbasis5.1-en-US-calc lodevbasis5.1-ooofonts lodevbasis5.1-images lodevbasis5.1-filter-data lodevbasis5.1-draw lodevbasis5.1-base lodevbasis5.1-en-US-writer lodevbasis5.1-en-US-math lodevbasis5.1-en-US-base

%define owner lool
%define group lool

%description

%prep
%setup -q

%build
%configure --with-lokit-path=bundled/include

env BUILDING_FROM_RPMBUILD=yes make %{?_smp_mflags}

%check
env BUILDING_FROM_RPMBUILD=yes make check

%install
env BUILDING_FROM_RPMBUILD=yes make install DESTDIR=%{buildroot}

%files
/usr/bin/loolwsd
/usr/bin/loolwsd-systemplate-setup

%doc README

%post
setcap cap_fowner,cap_sys_chroot=ep /usr/bin/loolwsd

getent group %{group} >/dev/null || groupadd -r %{group}
getent passwd %{owner} >/dev/null || useradd -g %{group} -r %{owner}

mkdir -p /var/cache/loolwsd && chmod og+w /var/cache/loolwsd

# Figure out where LO is installed, let's hope it is not a mount point
# Create a directory for loolwsd on the same file system
loroot=`rpm -ql libreofficedev5.1 | grep '/soffice$' | sed -e 's-/program/soffice--'`
loolparent=`cd ${loroot} && cd .. && /bin/pwd`

rm -rf ${loolparent}/lool
mkdir -p ${loolparent}/lool/child-roots
chown %{owner} ${loolparent}/lool
chown %{owner} ${loolparent}/lool/child-roots

su %{owner} -c "loolwsd-systemplate-setup ${loolparent}/lool/systemplate ${loroot} >/dev/null"

%changelog
* Tue May 19 2015 Tor Lillqvist
- Initial RPM release

